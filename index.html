<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>地震情報ビューアーv1.3.3</title>
<style>
body {
  font-family:"Yu Gothic","YuGothic","メイリオ",sans-serif;
  white-space: pre-wrap;
  margin: 5px;
  padding: 5px;
  background: #fff;
  font-size: 14px;
  line-height: 1.4;
}
#eew { 
  margin: 0; 
  padding: 0; 
  font-family:"Yu Gothic","YuGothic","メイリオ",sans-serif;
}
#status { 
  font-size: 12px; 
  margin-bottom: 0px; 
}
#copyBtn {
  font-size: 12px;
  padding: 2px 5px;
  margin-bottom: 0px;
  cursor: pointer;
}
</style>
</head>
<body>
<div id="status">更新中...</div>
<button id="copyBtn">本文をコピー</button>
<pre id="eew">読み込み中...</pre>

<script>
// DOM
const outputEl = document.getElementById("eew");
const statusEl = document.getElementById("status");
const copyBtn = document.getElementById("copyBtn");

// 日時フォーマット
function formatDate(date, format="yyyy/MM/dd HH:mm:ss"){
  const z = n => n.toString().padStart(2,"0");
  return format.replace("yyyy", date.getFullYear())
               .replace("MM", z(date.getMonth()+1))
               .replace("dd", z(date.getDate()))
               .replace("HH", z(date.getHours()))
               .replace("mm", z(date.getMinutes()))
               .replace("ss", z(date.getSeconds()));
}

// scale / depth / tsunami / area text
function scaleToText(scale){ 
  if(scale==null||scale<0) return "不明";
  const map = {10:'1',20:'2',30:'3',40:'4',45:'5弱',50:'5強',55:'6弱',60:'6強',70:'7'};
  return map[scale]||'不明';
}
function depthToText(depth){
  if(depth==null||depth<0) return "不明";
  if(depth===0) return "ごく浅い";
  return depth+"km";
}
function buildTsunamiText(domestic, foreign){
  const d = domestic||"Unknown";
  const f = foreign||"";
  if(d==="Warning"||d==="Watch") return "津波に関する情報を発表しています。";
  if(d==="NonEffective") return "津波予報(若干の海面変動)を発表していますが、被害の心配はありません。";
  if(d==="None"){
    if(f==="Warning"||f==="Watch"||f==="WarningNearby") return "この地震による国内での津波の心配はありません。";
    return "この地震による津波の心配はありません。";
  }
  if(d==="Checking") return "この地震による津波の有無を現在調査中です。";
  if(d==="Unknown") return "この地震による津波の有無は不明です。";
  return "#Tsunami:Error!";
}
function intensityDescription(scale){
  return {'3':'揺れを感じました','4':'やや強い揺れを感じました','5弱':'強い揺れを感じました','5強':'強い揺れを感じました','6弱':'激しい揺れを感じました','6強':'激しい揺れを感じました','7':'非常に激しい揺れを感じました'}[scale]||'';
}
function compareScale(a,b){const order={'1':10,'2':20,'3':30,'4':40,'5弱':45,'5強':50,'6弱':55,'6強':60,'7':70};return(order[a]||0)-(order[b]||0);}


// ★★★ buildAreaText をあなたの仕様に完全置き換え ★★★
function buildAreaText(points) {
  let chiiki = "0";
  if (!points || points.length === 0) return "▽震度情報不明\n";
  const cityMaxScale = {};
  const specialCities = ["市川市","市原市","野々市市","四日市市","田村市","町田市","十日町市","大町市",
                         "山村市","田村市","東村山市","武蔵村山市","羽村市","大村市","余市町","市貝町",
                         "上市町","市川三郷町","市川町","下市町","大町町","村田町","玉村町","中村区"];

  points.forEach(p => {
    if (p.isArea) {
      chiiki = "1";
      const scale = scaleToText(p.scale);
      const addr = p.addr; // 例: "鳥取県西部" や "東京都千代田区"
      const city = addr.replace(/^(.*?[都道府県])/, '');
      const key = `${p.pref}:${city}`;
      if (!cityMaxScale[key] || compareScale(scale, cityMaxScale[key]) > 0) {
        cityMaxScale[key] = scale;
      }
    } else {
      const scale = scaleToText(p.scale);
      let city = null;

      // 特殊地名
      for (const s of specialCities) {
        if (p.addr.includes(s)) {
          city = s;
          break;
        }
      }

      // 通常地名
      if (!city) {
        const cityMatch = p.addr.match(/(.+?[市区町村])/);
        city = cityMatch ? cityMatch[1] : p.addr;
      }

      const key = `${p.pref}:${city}`;
      if (!cityMaxScale[key] || compareScale(scale, cityMaxScale[key]) > 0) {
        cityMaxScale[key] = scale;
      }
    }
  });

  const grouped = {};
  Object.keys(cityMaxScale).forEach(k => {
    const [pref, city] = k.split(':');
    const scale = cityMaxScale[k];
    if (!grouped[scale]) grouped[scale] = {};
    if (!grouped[scale][pref]) grouped[scale][pref] = [];
    grouped[scale][pref].push(city);
  });

  const prefOrder = [
    "北海道","青森県","秋田県","岩手県","宮城県","山形県","福島県",
    "茨城県","栃木県","群馬県","埼玉県","東京都","千葉県","神奈川県",
    "山梨県","静岡県","愛知県","岐阜県","福井県","石川県","富山県","長野県","新潟県",
    "滋賀県","京都府","奈良県","三重県","和歌山県","大阪府","兵庫県",
    "鳥取県","岡山県","島根県","広島県","山口県","香川県","徳島県","高知県","愛媛県",
    "福岡県","大分県","宮崎県","鹿児島県","熊本県","佐賀県","長崎県","沖縄県"
  ];

  let text = "";
  Object.keys(grouped).sort((a,b)=>compareScale(b,a)).forEach(scale=>{
    text += `\n▽震度${scale}\n`;
    prefOrder.forEach(pref=>{
      if(grouped[scale][pref]){
        if (chiiki==="1") {
          const cities = grouped[scale][pref].sort().join(" ");
          text += `【${pref}】${cities}\n`;
        } else {
          const cities = grouped[scale][pref].sort().join("　");
          text += `【${pref}】\n${cities}\n`;
        }
      }
    });
  });
  return text.trim();
}
// ★★★ ここまで buildAreaText ★★★



// buildEarthquakeBody（変更なし）
function buildEarthquakeBody(latest){
  const eq = latest.earthquake;
  const h = eq.hypocenter||{};
  const place = h.name||"(発生地点不明)";
  const maxScale = scaleToText(eq.maxScale);
  const magnitude = (h.magnitude!=null&&h.magnitude>=0)?h.magnitude.toFixed(1):"不明";
  const depth = depthToText(h.depth);
  const tsunamiText = buildTsunamiText(eq.domesticTsunami, eq.foreignTsunami);
  const commentText = (latest.comments&&latest.comments.freeFormComment)?`${latest.comments.freeFormComment.trim()}`:"";
  const intensityInfo = (latest.points&&latest.points.length>0)?buildAreaText(latest.points):"▽震度情報不明";

  switch(latest.issue?.type){
    case "ScalePrompt":
      return `《震度速報》
${formatDate(new Date(eq.time),"HH時mm分")}頃、${intensityDescription(maxScale)}。
　最大震度:${maxScale}
${tsunamiText}${commentText}

　●各地の震度情報●
${intensityInfo}

出典：P2P地震情報API(気象庁)`;
    case "Destination":
      return `《震源速報》
${formatDate(new Date(eq.time),"HH時mm分")}頃、${place}で地震がありました。
　M${magnitude}
　震源の深さ:${depth}
${tsunamiText}${commentText}

出典：P2P地震情報API(気象庁)`;
    case "DetailScale":
    case "Foreign":
    default:
      return `《地震情報》
${formatDate(new Date(eq.time),"yyyy年MM月dd日HH時mm分")}頃、${place}で地震がありました。
　最大震度:${maxScale}
　M${magnitude}
　震源の深さ:${depth}
${tsunamiText}${commentText}

　●各地の震度情報●
${intensityInfo}

出典：P2P地震情報API(気象庁)`;
  }
}

// updateEQ
async function updateEQ(){
  const url = "https://api.p2pquake.net/v2/history?codes=551&limit=1&offset";
  try{
    const response = await fetch(url);
    if(!response.ok) throw new Error(`APIアクセスエラー: ${response.status}`);
    const data = await response.json();
    if(!data||data.length===0){ outputEl.textContent="データが存在しません"; return; }

    const messages = data.slice(0,5).map(buildEarthquakeBody);
    outputEl.textContent = messages.join("\n\n--------------------\n\n");

    statusEl.textContent = `最終更新: ${formatDate(new Date())}`;
  }catch(e){
    outputEl.textContent="取得エラー: "+e.message;
  }
}

// 初回と自動更新
updateEQ();
setInterval(updateEQ, 2000);

// コピー機能
copyBtn.addEventListener("click",()=>{
  const text = outputEl.textContent;
  navigator.clipboard.writeText(text).then(()=>{
    const original = copyBtn.textContent;
    copyBtn.textContent="コピー完了";
    setTimeout(()=>{copyBtn.textContent=original;},1500);
  }).catch(err=>{
    alert("コピーに失敗しました: "+err);
  });
});
</script>
</body>
</html>
